<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Friend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: pop-in 0.3s ease-out forwards;
        }
        @keyframes pop-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4a5568;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-4 my-8 bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh]">
        <!-- Header -->
        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-blue-500 to-purple-600 rounded-t-2xl text-white shadow-lg">
            <div>
                <h1 class="text-2xl font-bold">My Friend</h1>
                <p class="text-sm opacity-80 mt-1">Your personal AI journal</p>
            </div>
            <div class="flex items-center space-x-4">
                 <span class="font-semibold text-lg">Rahul</span>
                 <button id="settings-button" class="text-white hover:text-gray-200 transition-transform duration-200 hover:rotate-45">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                 </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 space-y-4 overflow-y-auto bg-gray-50">
            <!-- Messages will be appended here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden p-6 bg-gray-50">
            <div class="flex items-start space-x-3">
                 <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                </div>
                <div class="bg-gray-200 rounded-lg p-3">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <textarea id="userInput" rows="1" class="flex-1 p-3 bg-gray-100 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition" placeholder="Log your activities for today..."></textarea>
                <button id="sendButton" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-full hover:opacity-90 active:scale-95 transition-all duration-150 shadow-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center invisible opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-transform duration-300 scale-95">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Memory Settings</h2>
            <p class="text-sm text-gray-500 mb-4">Store key information for me to remember, like your long-term goals, priorities, or personal preferences.</p>
            <textarea id="memory-input" class="w-full h-40 p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Example: My main goal this month is to finish my project presentation. I am trying to reduce screen time after 8 PM..."></textarea>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Cancel</button>
                <button id="save-button" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">Save</button>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loading-indicator');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const modalContent = settingsModal.querySelector('div');
        const memoryInput = document.getElementById('memory-input');
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');

        let conversationState = 'awaiting_log';
        let lastLog = '';
        let memory = localStorage.getItem('myFriendMemory') || '';
        
        const apiKey = "AIzaSyBpbNXDEDS7naBDeCEcHctnRjIcAYCOBhM"; // API key is handled by the environment

        const addMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'items-start', 'space-x-3', 'max-w-lg', 'chat-bubble');
            let formattedMessage = message.replace(/\n/g, '<br>');

            if (sender === 'user') {
                messageDiv.classList.add('ml-auto', 'justify-end');
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white p-3 rounded-lg shadow-md" style="border-top-right-radius: 4px;">
                        <p class="text-sm">${formattedMessage}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                         <svg class="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    </div>
                    <div class="bg-white text-gray-800 p-3 rounded-lg shadow-sm" style="border-top-left-radius: 4px;">
                        <p class="text-sm">${formattedMessage}</p>
                    </div>
                `;
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const handleUserInput = async () => {
            const userText = userInput.value.trim();
            if (!userText) return;

            addMessage(userText, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';

            switch (conversationState) {
                case 'awaiting_log':
                    lastLog = userText;
                    setTimeout(() => {
                        addMessage("Got it. Your activities have been noted.\n\nThanks for sharing. Would you like me to provide a brief analysis of your day?", 'ai');
                        conversationState = 'awaiting_analysis_confirmation';
                    }, 500);
                    break;

                case 'awaiting_analysis_confirmation':
                    const positiveResponses = ['yes', 'yep', 'sure', 'ok', 'yeah', 'please', 'alright'];
                    if (positiveResponses.some(res => userText.toLowerCase().includes(res))) {
                        loadingIndicator.classList.remove('hidden');
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        try {
                            const analysis = await getAnalysisFromGemini(lastLog, memory);
                            addMessage(analysis, 'ai');
                        } catch (error) {
                            console.error('Error getting analysis:', error);
                            addMessage("I'm sorry, I had trouble generating the analysis. Please try again later.", 'ai');
                        } finally {
                            loadingIndicator.classList.add('hidden');
                            conversationState = 'awaiting_log';
                        }
                    } else {
                        addMessage("Alright, no problem. I'm here when you're ready to log your next entry!", 'ai');
                        conversationState = 'awaiting_log';
                    }
                    break;
            }
        };

        const getAnalysisFromGemini = async (log, memoryContext) => {
            let context = '';
            if (memoryContext) {
                context = `Please use the following information to personalize your response: ${memoryContext}.`;
            }

            const systemPrompt = `
                You are "My Friend," a dedicated, friendly, and insightful AI journal and productivity coach. Your primary goal is to help the user analyze their daily activities. Your tone should be supportive, non-judgmental, and motivational. ${context}
                
                Analyze the user's daily log based on these pillars:
                - Productivity: Identify tasks that seem to align with long-term goals (especially those mentioned in the memory context) and tasks that might be distractions.
                - Time Management: Note where the majority of time was spent.
                - Well-being: Look for mentions of breaks, exercise, hobbies, or expressions of stress or satisfaction.

                Structure your response using the following format EXACTLY, including the emojis. Do not add any introductory text before the summary.
                
                **- ðŸ“ Daily Summary:** A brief, one-paragraph overview of the day's activities.
                **- âœ… Key Achievements:** A bulleted list of the most productive or positive actions taken.
                **- ðŸ’¡ Observations & Suggestions:**
                    * **What Went Well:** Briefly mention something positive about the day's effort.
                    * **Areas to Consider:** Gently point out opportunities for improvement (e.g., time management, distractions).
                    * **Actionable Tip:** Provide a single, simple, and actionable productivity tip relevant to the user's day.
                **- â­ Motivational Closing:** End with a short, encouraging message.
            `;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `Here is my daily log: ${log}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                return "I couldn't generate an analysis from that. Could you try rephrasing your log?";
            }
        };
        
        const openModal = () => {
            memoryInput.value = memory;
            settingsModal.classList.remove('invisible', 'opacity-0');
            modalContent.classList.remove('scale-95');
        };

        const closeModal = () => {
            modalContent.classList.add('scale-95');
            settingsModal.classList.add('invisible', 'opacity-0');
        };

        // Event Listeners
        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserInput();
            }
        });
        
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });

        settingsButton.addEventListener('click', openModal);
        cancelButton.addEventListener('click', closeModal);
        saveButton.addEventListener('click', () => {
            memory = memoryInput.value.trim();
            localStorage.setItem('myFriendMemory', memory);
            closeModal();
            addMessage('Got it! I\'ll remember that for our future chats.', 'ai');
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                addMessage("Hello! I'm My Friend, your personal AI journal. I'm here to help you reflect on your day.\n\nWhenever you're ready, tell me what you did today.", 'ai');
            }, 500);
        });
    </script>
</body>
</html>

